<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sipariş Formu | Ediz Kepir</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root { --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --accent: #007aff; --border: #d1d1d6; }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 40px 20px; line-height: 1.4; }
    .container { max-width: 1150px; margin: 0 auto; }
    .site-header { margin-bottom: 30px; border-left: 6px solid var(--text); padding-left: 20px; }
    .card { background: var(--card); border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
    .card-label { font-size: 10px; font-weight: 800; color: #8e8e93; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: block; }
    .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 25px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    label { font-size: 12px; font-weight: 700; margin-bottom: 6px; color: #3a3a3c; display: block; }
    input, select { width: 100%; border: 1.2px solid var(--border); padding: 12px; border-radius: 10px; font-size: 14px; font-family: inherit; outline: none; background: #fafafa; }
    input:focus { border-color: var(--text); background: #fff; }
    
    /* Ek Hizmetler Stili */
    .addon-item { border: 1.2px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px; transition: 0.2s; cursor: pointer; }
    .addon-item.active { border-color: var(--accent); background: #f0f7ff; box-shadow: 0 0 10px rgba(0,122,255,0.1); }
    .addon-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .addon-info b { font-size: 14px; }
    .addon-info span { font-size: 11px; color: #8e8e93; }
    .qty-input { width: 70px !important; padding: 8px !important; text-align: center; }

    .sticky-side { position: sticky; top: 20px; }
    .price-card { background: var(--text); color: #fff; border-radius: 20px; padding: 35px; text-align: center; }
    .price-main { font-size: 38px; font-weight: 900; margin: 10px 0; letter-spacing: -1px; }
    .btn-finalize { width: 100%; background: #fff; color: #000; border: none; padding: 18px; border-radius: 12px; font-size: 14px; font-weight: 800; cursor: pointer; margin-top: 15px; text-transform: uppercase; transition: 0.3s; }
    .btn-finalize:disabled { opacity: 0.4; cursor: not-allowed; }
    .price-mini { text-align:left; font-size:12px; opacity:0.85; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px; margin-top:15px; line-height: 1.8; }

    /* PDF Gizli Alanı */
    #pdf-wrapper { position: absolute; left: -9999px; top: -9999px; }
    .pdf-A4 { width: 210mm; background: #fff; color: #000; padding: 20mm; font-family: 'Inter', sans-serif; }
  </style>
</head>
<body>

<div class="container">
  <header class="site-header">
    <h1 style="font-size: 26px; font-weight: 800;">3D Görselleştirme Sipariş Formu</h1>
    <p style="color: #8e8e93; font-weight: 600;">EDİZ KEPİR | SENIOR LEAD CG ARTIST</p>
  </header>

  <div class="main-layout">
    <div class="form-side">
      <div class="card">
        <span class="card-label">01. Kurumsal Bilgiler</span>
        <div class="row">
          <div class="input-wrap"><label>Firma / Şirket İsmi *</label><input type="text" id="firm" placeholder="Firma Adı"></div>
          <div class="input-wrap"><label>Yetkili İrtibat *</label><input type="text" id="auth" placeholder="Ad Soyad"></div>
        </div>
        <div class="row">
          <div class="input-wrap"><label>Başlangıç Tarihi *</label><input type="date" id="sDate" onchange="run()"></div>
          <div class="input-wrap"><label>İletişim (Tel/E-posta) *</label><input type="text" id="contact" placeholder="İletişim Bilgisi"></div>
        </div>
      </div>

      <div class="card">
        <span class="card-label">02. Model Yapılandırması</span>
        <div class="row">
          <div class="input-wrap"><label>3D Model Adedi (Az adet yüksek maliyettir)</label><input type="number" id="units" value="1" min="1" oninput="run()"></div>
          <div class="input-wrap"><label>Poz Protokolü</label>
            <select id="poses" onchange="run()">
              <option value="4">4 Poz (Detay Paket)</option>
              <option value="6" selected>6 Poz (Optimize Paket)</option>
              <option value="12">12 Poz (Premium Katalog)</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="input-wrap"><label>Görsel Standartı (Çözünürlük)</label>
            <select id="res" onchange="run()">
              <option value="1000">HD (1080p)</option>
              <option value="2000" selected>2K QHD Master</option>
              <option value="4000">4K Ultra HD</option>
              <option value="8000">8K Cinematic</option>
              <option value="16000">16K Printing Master</option>
            </select>
          </div>
          <div class="input-wrap"><label>İşlem Hızı Önceliği</label>
            <select id="speed" onchange="run()">
              <option value="1.0">Standart (30 İş Günü)</option>
              <option value="1.7">Express (15 İş Günü)</option>
              <option value="2.9">Quantum (7 İş Günü)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <span class="card-label">03. Ek Teknik Hizmetler</span>
        
        <div class="addon-item" id="box-m1" onclick="toggleM('m1')">
          <div class="addon-info"><b>360° Loop Animation</b><span>(+10.000 TL / adet)</span></div>
          <input type="number" id="q1" value="1" min="1" class="qty-input" oninput="event.stopPropagation(); run()">
          <input type="checkbox" id="m1" style="display:none">
        </div>

        <div class="addon-item" id="box-m2" onclick="toggleM('m2')">
          <div class="addon-info"><b>Exploded View (Kesit Görünüm)</b><span>(+12.000 TL / adet)</span></div>
          <input type="number" id="q2" value="1" min="1" class="qty-input" oninput="event.stopPropagation(); run()">
          <input type="checkbox" id="m2" style="display:none">
        </div>

        <div class="addon-item" id="box-m3" onclick="toggleM('m3')">
          <div class="addon-info"><b>HDR Studio Mastering</b><span>(+8.000 TL sabit)</span></div>
          <input type="checkbox" id="m3" style="display:none">
        </div>

        <div class="addon-item" id="box-m4" onclick="toggleM('m4')">
          <div class="addon-info"><b>Peşin Ödeme Avantajı</b><span>(%10 İndirim Uygulanır)</span></div>
          <input type="checkbox" id="m4" style="display:none">
        </div>
      </div>
    </div>

    <div class="sticky-side">
      <div class="price-card">
        <span class="card-label" style="color:rgba(255,255,255,0.5)">Stratejik Yatırım Bedeli</span>
        <h2 class="price-main" id="ui-total">0 TL</h2>
        <div class="price-mini">
          <p>Birim Poz Maliyeti: <b id="ui-up">0 TL</b></p>
          <p>Model Adet Çarpanı: <b id="ui-mult">1.0x</b></p>
          <p>Ek Hizmetler Toplamı: <b id="ui-extra">0 TL</b></p>
        </div>
        <button class="btn-finalize" id="finalBtn" onclick="finalize()">Siparişi Onayla ve Kaydet</button>
      </div>
    </div>
  </div>
</div>

<div id="pdf-wrapper">
  <div id="pdf-doc" class="pdf-A4">
    <h2 style="border-bottom: 2px solid #000; padding-bottom: 10px;">SİPARİŞ ÖZETİ</h2>
    <p><b>Firma:</b> <span id="p-firm"></span></p>
    <p><b>ID:</b> <span id="p-id"></span></p>
    <p><b>Başlangıç:</b> <span id="p-date"></span></p>
    <p><b>Teknik Detay:</b> <span id="p-detail"></span></p>
    <hr style="margin: 20px 0;">
    <div id="p-extras-list"></div>
    <div style="background: #eee; padding: 20px; margin-top: 30px; text-align: center;">
      <h3>TOPLAM BEDEL: <span id="p-total"></span></h3>
    </div>
  </div>
</div>

<script>
  const qs = (id) => document.getElementById(id);

  function toggleM(id) {
    const cb = qs(id);
    cb.checked = !cb.checked;
    qs('box-' + id).classList.toggle('active', cb.checked);
    run();
  }

  function run() {
    const units = parseInt(qs('units').value) || 1;
    const poses = parseInt(qs('poses').value);
    const resValue = parseInt(qs('res').value);
    const speedMult = parseFloat(qs('speed').value);

    // 1. Çözünürlük Bazlı Katsayı (HD=1, 2K=1.2, 4K=2, 8K=4, 16K=8)
    let resMult = 1;
    if(resValue === 2000) resMult = 1.2;
    if(resValue === 4000) resMult = 2.0;
    if(resValue === 8000) resMult = 4.0;
    if(resValue === 16000) resMult = 8.0;

    // 2. Adet Caydırıcılığı / Ölçeklendirme
    // 1-2 adet için 1.5x fiyat, 3-5 için 1.2x, 10+ için 1.0x
    let unitScale = 1.5;
    if(units >= 3) unitScale = 1.2;
    if(units >= 10) unitScale = 1.0;

    // 3. Temel Hesaplama
    const baseUnitPrice = 5000; // Baz fiyat
    const currentUnitPrice = baseUnitPrice * resMult * speedMult * unitScale;
    let total = (units * poses) * currentUnitPrice;

    // 4. Ek Hizmetler
    let extras = 0;
    if(qs('m1').checked) extras += 10000 * (parseInt(qs('q1').value) || 1);
    if(qs('m2').checked) extras += 12000 * (parseInt(qs('q2').value) || 1);
    if(qs('m3').checked) extras += 8000;

    total += extras;

    // 5. İndirim
    if(qs('m4').checked) total *= 0.9;

    // 6. Minimum Proje Bedeli (Caydırıcı Alt Sınır)
    if(total < 25000) total = 25000;

    // UI Güncelleme
    qs('ui-total').innerText = Math.round(total).toLocaleString('tr-TR') + " TL";
    qs('ui-up').innerText = Math.round(currentUnitPrice).toLocaleString('tr-TR') + " TL";
    qs('ui-mult').innerText = unitScale + "x (Adet Çarpanı)";
    qs('ui-extra').innerText = extras.toLocaleString('tr-TR') + " TL";

    return { total: Math.round(total).toLocaleString('tr-TR') + " TL", units, poses, res: qs('res').options[qs('res').selectedIndex].text };
  }

  async function finalize() {
    const firm = qs('firm').value.trim();
    const btn = qs('finalBtn');
    if(!firm) { alert("Firma adı zorunludur."); return; }

    btn.disabled = true;
    btn.innerText = "KAYDEDİLİYOR...";

    const data = run();
    const spid = "EK-" + Math.random().toString(36).substring(2,7).toUpperCase();

    // PDF Hazırlık
    qs('p-firm').innerText = firm;
    qs('p-id').innerText = spid;
    qs('p-date').innerText = qs('sDate').value;
    qs('p-total').innerText = data.total;
    qs('p-detail').innerText = `${data.units} Model x ${data.poses} Poz | ${data.res}`;

    try {
      // 1. PDF Üret
      await html2pdf().from(qs('pdf-doc')).save(`Siparis_${firm}_${spid}.pdf`);

      // 2. Netlify Fonksiyonuna Gönder
      await fetch("/.netlify/functions/create-order", {
        method: "POST",
        body: JSON.stringify({ spid, firm, total: data.total, contact: qs('contact').value })
      });

      alert("Sipariş başarıyla oluşturuldu.");
    } catch(e) {
      alert("Sipariş veritabanına işlenirken bir sorun oluştu ancak PDF'iniz hazır.");
    } finally {
      btn.disabled = false;
      btn.innerText = "Siparişi Onayla ve Kaydet";
    }
  }

  // İlk çalıştırma
  run();
</script>

</body>
</html>
