<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sipariş Formu | Ediz Kepir</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root { --bg: #f2f2f7; --card: #ffffff; --text: #1c1c1e; --accent: #007aff; --border: #d1d1d6; }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 40px 20px; line-height: 1.4; }
    .container { max-width: 1100px; margin: 0 auto; }
    .site-header { margin-bottom: 30px; border-left: 6px solid var(--text); padding-left: 20px; }
    .card { background: var(--card); border-radius: 16px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
    .card-label { font-size: 10px; font-weight: 800; color: #8e8e93; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: block; }
    .main-layout { display: grid; grid-template-columns: 1fr 350px; gap: 25px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    label { font-size: 12px; font-weight: 700; margin-bottom: 6px; color: #3a3a3c; display: block; }
    input, select { width: 100%; border: 1.2px solid var(--border); padding: 12px; border-radius: 10px; font-size: 14px; font-family: inherit; outline: none; background: #fafafa; }
    input:focus { border-color: var(--text); background: #fff; }
    .addon-item { border: 1.2px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 15px; transition: 0.2s; }
    .addon-item.active { border-color: var(--text); background: #fdfdfd; }
    .addon-info { flex: 1; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .qty-input { width: 70px !important; padding: 8px !important; text-align: center; }
    .sticky-side { position: sticky; top: 20px; }
    .price-card { background: var(--text); color: #fff; border-radius: 20px; padding: 35px; text-align: center; }
    .price-main { font-size: 34px; font-weight: 900; margin: 10px 0; letter-spacing: -1px; }
    .btn-finalize { width: 100%; background: #fff; color: #000; border: none; padding: 18px; border-radius: 12px; font-size: 14px; font-weight: 800; cursor: pointer; margin-top: 12px; text-transform: uppercase; transition: 0.3s; }
    .btn-finalize:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-ghost { width: 100%; background: transparent; color: #fff; border: 1px solid rgba(255,255,255,0.3); padding: 12px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; margin-top: 12px; }
    .price-mini { text-align:left; font-size:12px; opacity:0.85; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px; margin-top:15px; }
    #pdf-wrapper { position: absolute; left: -9999px; top: -9999px; }
    .pdf-A4 { width: 210mm; background: #fff !important; color: #000 !important; padding: 25mm; font-family: 'Inter', sans-serif; position: relative; }
    .pdf-header { border-bottom: 4px solid #000; padding-bottom: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
    .pdf-total-box { margin-top: 40px; padding: 25px; background: #f9f9f9; border: 2.5px solid #000; text-align: center; }
    @media (max-width: 960px) { .main-layout { grid-template-columns: 1fr; } .sticky-side { position: static; } }
  </style>
</head>
<body>

<div class="container">
  <header class="site-header">
    <h1 style="font-size: 26px; font-weight: 800;">3D Görselleştirme Sipariş Formu</h1>
    <p style="color: #8e8e93; font-weight: 600;">EDİZ KEPİR | SENIOR LEAD CG ARTIST</p>
  </header>

  <div class="main-layout">
    <div class="form-side">
      <div class="card">
        <span class="card-label">01. Kurumsal Bilgiler</span>
        <div class="row">
          <div class="input-wrap"><label>Firma / Şirket İsmi *</label><input type="text" id="firm" placeholder="Firma Adı"></div>
          <div class="input-wrap"><label>Yetkili İrtibat *</label><input type="text" id="auth" placeholder="Ad Soyad"></div>
        </div>
        <div class="row">
          <div class="input-wrap"><label>Başlangıç Tarihi *</label><input type="date" id="sDate" onchange="run()"></div>
          <div class="input-wrap"><label>İletişim (Tel/E-posta) *</label><input type="text" id="contact" placeholder="İletişim Detayı"></div>
        </div>
      </div>

      <div class="card">
        <span class="card-label">02. Model Yapılandırması</span>
        <div class="row">
          <div class="input-wrap"><label>3D Model Adedi</label><input type="number" id="units" value="1" min="1" oninput="run()"></div>
          <div class="input-wrap"><label>Poz Protokolü</label>
            <select id="poses" onchange="run()">
              <option value="4">4 Poz (Standart Dışı)</option>
              <option value="6" selected>6 Poz (Optimize)</option>
              <option value="12">12 Poz (Premium)</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="input-wrap"><label>Standart</label>
            <select id="res" onchange="run()">
              <option value="1000">HD Ready</option>
              <option value="2000" selected>4K Ultra Master</option>
              <option value="5000">8K Cinematic</option>
            </select>
          </div>
          <div class="input-wrap"><label>İşlem Hızı</label>
            <select id="speed" onchange="run()">
              <option value="1.0">Standart (30 Gün)</option>
              <option value="1.7">Express (15 Gün)</option>
              <option value="2.9">Quantum (7 Gün)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <span class="card-label">03. Ek Hizmetler</span>
        <div class="addon-item" id="box-m1">
          <div class="addon-info" onclick="toggleM('m1')"><b>360° Loop Animation</b></div>
          <input type="number" id="q1" value="1" min="1" class="qty-input" oninput="run()">
          <input type="checkbox" id="m1" style="display:none">
        </div>
        <div class="addon-item" id="box-m2">
          <div class="addon-info" onclick="toggleM('m2')"><b>Exploded View (Kesit)</b></div>
          <input type="number" id="q2" value="1" min="1" class="qty-input" oninput="run()">
          <input type="checkbox" id="m2" style="display:none">
        </div>
        <div class="addon-item" id="box-m4">
          <div class="addon-info" onclick="toggleM('m4')"><b>Peşin Ödeme Avantajı (-10%)</b></div>
          <input type="checkbox" id="m4" style="display:none">
        </div>
      </div>
    </div>

    <div class="sticky-side">
      <div class="price-card">
        <h2 class="price-main" id="ui-total">0 TL</h2>
        <div class="price-mini">
          <p>Birim: <b id="ui-up">0 TL</b></p>
          <p>Ekstra: <b id="ui-extra">0 TL</b></p>
        </div>
        <button class="btn-finalize" id="finalBtn" onclick="finalize()">Siparişi Onayla ve Kaydet</button>
      </div>
    </div>
  </div>
</div>

<div id="pdf-wrapper">
  <div id="pdf-doc" class="pdf-A4">
    <div class="pdf-header">
      <div><h1>SİPARİŞ FORMU</h1><p>EDİZ KEPİR | SENIOR LEAD CG ARTIST</p></div>
      <div style="text-align:right">ID: <b id="p-id">---</b><br><span id="p-created-date">---</span></div>
    </div>
    <p><b>Firma:</b> <span id="p-firm">---</span></p>
    <p><b>Yetkili:</b> <span id="p-auth">---</span></p>
    <p><b>Tarih:</b> <span id="p-date">---</span></p>
    <div id="p-extras-list" style="margin-top:20px"></div>
    <div class="pdf-total-box"><h1 id="p-total">0 TL</h1></div>
  </div>
</div>

<script>
  const qs = (id) => document.getElementById(id);

  function safeInt(id, fallback = 0) {
    const v = parseInt(qs(id).value, 10);
    return isNaN(v) ? fallback : v;
  }

  function toggleM(id) {
    const cb = qs(id);
    cb.checked = !cb.checked;
    qs('box-' + id).classList.toggle('active', cb.checked);
    run();
  }

  function run() {
    const units = safeInt('units', 1);
    const poses = parseInt(qs('poses').value, 10);
    const res = parseInt(qs('res').value, 10);
    const speed = parseFloat(qs('speed').value);

    const unitP = res * (poses === 4 ? 1.3 : 1.0) * speed;
    let total = (units * poses) * unitP;

    let extras = 0;
    if (qs('m1').checked) extras += 10000 * safeInt('q1', 1);
    if (qs('m2').checked) extras += 12000 * safeInt('q2', 1);
    
    total += extras;
    if (qs('m4').checked) total *= 0.9;
    if (total < 15000) total = 15000;

    const totalStr = Math.round(total).toLocaleString('tr-TR') + " TL";
    qs('ui-total').innerText = totalStr;
    qs('ui-up').innerText = Math.round(unitP).toLocaleString('tr-TR') + " TL";
    qs('ui-extra').innerText = Math.round(extras).toLocaleString('tr-TR') + " TL";

    return { total: totalStr, unitPrice: unitP, extras: extras };
  }

  async function finalize() {
    const firm = qs('firm').value.trim();
    const auth = qs('auth').value.trim();
    const contact = qs('contact').value.trim();
    const btn = qs('finalBtn');

    if (!firm || !auth || !contact) {
      alert('Lütfen tüm alanları doldurun.');
      return;
    }

    btn.disabled = true;
    btn.innerText = "İŞLENİYOR...";

    const data = run();
    const spid = Math.random().toString(36).slice(2, 8).toUpperCase();

    // PDF Verilerini Bas
    qs('p-id').innerText = "#SP-" + spid;
    qs('p-created-date').innerText = new Date().toLocaleDateString('tr-TR');
    qs('p-firm').innerText = firm;
    qs('p-auth').innerText = auth + " (" + contact + ")";
    qs('p-date').innerText = qs('sDate').value;
    qs('p-total').innerText = data.total;

    // PDF Oluştur
    const opt = {
      margin: 0,
      filename: `Siparis_${firm}_${spid}.pdf`,
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    try {
      // 1. PDF İndir
      await html2pdf().from(qs('pdf-doc')).set(opt).save();

      // 2. Netlify / Telegram Gönderimi
      const response = await fetch("/.netlify/functions/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          spid: spid,
          firm: firm,
          auth: auth,
          contact: contact,
          total: data.total,
          date: qs('sDate').value
        })
      });

      if(response.ok) alert("Sipariş alındı ve PDF oluşturuldu.");
      else throw new Error("Sunucu hatası");

    } catch (err) {
      console.error(err);
      alert("İşlem sırasında bir hata oluştu ama PDF indirilmiş olabilir.");
    } finally {
      btn.disabled = false;
      btn.innerText = "SİPARİŞİ ONAYLA VE KAYDET";
    }
  }

  run(); // Başlangıç hesaplaması
</script>
</body>
</html>
